<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="./templates/master.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:co="http://i2m.dk/jsf/converge"
                xmlns:cof="http://i2m.dk/jsf/converge/functions"
                xmlns:bootstrap="http://i2m.dk/jsf/bootstrap"
                xmlns:h2="http://i2m.dk/jsf/html"
                xmlns:core="http://java.sun.com/jsf/composite/components/core">

    <f:metadata>
        <f:viewParam name="workflow_definition_id" value="#{workflowDefinitionDetails.id}"
                     converterMessage="#{msgs.WorkflowDefinitionDetails_WORKFLOW_DEFINITION_ID_CONVERTER_MESSAGE}"
                     validatorMessage="#{msgs.WorkflowDefinitionDetails_WORKFLOW_DEFINITION_ID_VALIDATOR_MESSAGE}">
            <f:validateLongRange minimum="1"/>
        </f:viewParam>
    </f:metadata>

    <ui:param name="menu" value="workflows" />

    <ui:define name="title">#{msgs.WorkflowDefinitionDetails_TITLE}</ui:define>
    <ui:define name="body">
        <h:form id="frmWorkflowDefinitionDetailsEdit" styleClass="form-horizontal">

            <h:panelGroup id="pageContentEdit" styleClass="span8 well" layout="span">
                <bootstrap:messages />

                <c:if test="#{!workflowDefinitionDetails.new}">
                    <h2 id="pageTitle">
                        <h:outputFormat value="#{msgs.WorkflowDefinitionDetails_DETAILS_OF_X}">
                            <f:param value="#{workflowDefinitionDetails.workflowDefinition.name}" />
                        </h:outputFormat>
                    </h2>
                </c:if>

                <c:if test="#{workflowDefinitionDetails.new}">
                    <h2 id="pageTitle">#{msgs.WorkflowDefinitionDetails_NEW_WORKFLOW_DEFINITION}</h2>
                </c:if>


                <ul class="nav nav-tabs">
                    <li class="active"><a href="#basic" data-toggle="tab">Basic</a></li>
                    <li><a href="#frmWorkflowDefinitionDetailsEdit\:tabWorkflowStates" data-toggle="tab">Workflow States</a></li>
                    <li><a href="#frmWorkflowDefinitionDetailsEdit\:tabWorkflowStartEndStates" data-toggle="tab">Special States</a></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="basic">

                        <bootstrap:fieldset label="Name and Description">
                            <bootstrap:controlGroup id="workflowName" 
                                                    label="Name" 
                                                    value="#{workflowDefinitionDetails.workflowDefinition.name}" 
                                                    helpText="Name of the workflow"
                                                    required="true" 
                                                    requiredMessage="The name of the workflow is required" />

                            <bootstrap:controlGroup id="workflowDescription" 
                                                    type="custom"
                                                    label="Description" 
                                                    helpText="Purpose of the workflow"
                                                    required="false">
                                <h:inputTextarea id="workflowDefinitionDescription" 
                                                 styleClass="input-xlarge" 
                                                 value="#{workflowDefinitionDetails.workflowDefinition.description}" />
                                <p class="help-block">Purpose of the workflow</p>
                            </bootstrap:controlGroup>
                        </bootstrap:fieldset>
                    </div>

                    <h:panelGroup layout="block" styleClass="tab-pane" id="tabWorkflowStates">
                        <h:panelGroup layout="block" id="innerTabWorkflowStates">
                            <bootstrap:fieldset label="Workflow States">
                                <h:outputText value="No states for #{workflowDefinitionDetails.workflowDefinition.name}. Click &lt;strong&gt;New Workflow State&lt;/strong&gt;." escape="false" rendered="#{empty workflowDefinitionDetails.workflowDefinition.states}"/>
                                <h:dataTable id="dtWorkflowStates" value="#{workflowDefinitionDetails.workflowDefinition.states}" var="workflowState" class="table table-bordered table-condensed table-striped" rendered="#{!empty workflowDefinitionDetails.workflowDefinition.states}">
                                    <h:column>
                                        <f:facet name="header">Name</f:facet>
                                        <h:outputText value="#{workflowState.name}" />
                                    </h:column>

                                    <h:column>
                                        <f:facet name="header">Permission</f:facet>
                                        <c:set var="key" value="dk.i2m.converge.ejb.entities.workflow.WorkflowStatePermission##{workflowState.permission}" />
                                        <h:outputText value="#{global[key]}" />
                                    </h:column>
                                    <h:column>
                                        <f:facet name="header">User Role</f:facet>
                                        <h:outputText value="#{workflowState.actorRole.name}" />
                                    </h:column>

                                    <h:column headerClass="workflow-state-options-column">
                                        <f:facet name="header">&nbsp;</f:facet>
                                        <h:commandLink title="Delete workflow state" actionListener="#{workflowDefinitionDetails.onDeleteWorkflowState(workflowState)}" styleClass="btn-workflow-state-option btn btn-small btn-danger">
                                            <f:ajax render=":frmWorkflowDefinitionDetailsEdit:innerTabWorkflowStates" />
                                            <i class="icon-white icon-trash" title="Delete"></i>
                                        </h:commandLink>

                                        <h:commandLink title="Properties of the workflow state" styleClass="btn-workflow-state-option btn btn-small btn-info" style="margin-left: 5px;">
                                            <f:setPropertyActionListener value="#{workflowState}" target="#{workflowDefinitionDetails.workflowState}" />
                                            <f:ajax render=":frmWorkflowStateDetails:mdlWorkflowStateDetails" onevent="onShowWorkflowState"/>
                                            <i class="icon-white icon-zoom-in" title="Open"></i>
                                            <h:outputText value="" />
                                        </h:commandLink>
                                        
                                        <h:commandLink title="Workflow options from this state (#{workflowState.numberOfOptions})" styleClass="btn-workflow-state-option btn btn-small btn-inverse" style="margin-left: 5px;">
                                            <f:ajax render=":frmWorkflowDefinitionDetailsEdit:innerTabWorkflowStates" />
                                            <i class="icon-white icon-random" title="#{workflowState.numberOfOptions}"></i>
                                        </h:commandLink>

                                    </h:column>
                                </h:dataTable>
                            </bootstrap:fieldset>
                            <script>
                                function onShowWorkflowState(e) {
                                    if (e.status == 'success') {
                                        $('#frmWorkflowStateDetails\\:mdlWorkflowStateDetails').modal('show');
                                    }
                                }
                            </script>

                        </h:panelGroup>
                    </h:panelGroup>

                    <h:panelGroup layout="block" styleClass="tab-pane" id="tabWorkflowStartEndStates">
                        <h:panelGroup layout="block" id="innerTabWorkflowStartEndStates">
                            <bootstrap:fieldset label="Start and End States">
                                <bootstrap:controlGroup id="startState"
                                                        type="select"
                                                        label="Start State" 
                                                        value="#{workflowDefinitionDetails.workflowDefinition.start}" 
                                                        helpText="First state of the workflow"
                                                        converter="#{workflowStateConverter}">
                                    <f:selectItems value="#{workflowDefinitionDetails.workflowStates}" />
                                </bootstrap:controlGroup>

                                <div class="control-group" id="endStates">
                                    <label class="control-label" for="endStates:input">End States</label>

                                    <h:panelGroup layout="block" styleClass="controls">
                                        <h:selectManyListbox id="input" 
                                                             value="#{workflowDefinitionDetails.workflowDefinition.endStates}" 
                                                             converter="#{workflowStateConverter}" 
                                                             >
                                            <f:selectItems value="#{workflowDefinitionDetails.workflowStates}" />
                                        </h:selectManyListbox>
                                        <p class="help-block">End states of the workflow</p>
                                    </h:panelGroup>
                                </div>
                            </bootstrap:fieldset>


                        </h:panelGroup>
                    </h:panelGroup>
                </div>
            </h:panelGroup>

            <h:panelGroup styleClass="span3" id="sidebar">
                <h:panelGroup layout="block">
                    <ul class="nav nav-list">
                        <li class="nav-header">Editing</li>
                        <li>
                            <h:commandButton styleClass="btn btn-large btn-primary btn-workflow-option" 
                                             value="#{global.generic_SAVE}" 
                                             action="#{workflowDefinitionDetails.onSave()}">
                            </h:commandButton>
                        </li>
                        <li>
                            <h:commandButton styleClass="btn btn-large btn-workflow-option" 
                                             value="#{global.generic_CANCEL}" immediate="true"
                                             action="Workflows?faces-redirect=true">
                            </h:commandButton>
                        </li>
                        <li class="nav-header">Options</li>
                        <li><h:commandLink immediate="true" actionListener="#{workflowDefinitionDetails.onNewWorkflowState()}">
                                <i class="icon-file"></i>
                                <h:outputText value="New Workflow State" />
                                <f:ajax render=":frmWorkflowStateDetails:mdlWorkflowStateDetails" onevent="onShowWorkflowState" />
                            </h:commandLink></li>
                    </ul>
                </h:panelGroup>
            </h:panelGroup>
        </h:form>

        <h:form id="frmWorkflowStateDetails">
            <bootstrap:modal id="mdlWorkflowStateDetails" title="Workflow State Details">
                <label>Name</label>
                <h:inputText id="workflowStateName" styleClass="input-xlarge" value="#{workflowDefinitionDetails.workflowState.name}" />

                <label>Description</label>
                <h:inputTextarea id="workflowStateDescription" 
                                 styleClass="input-xlarge" 
                                 value="#{workflowDefinitionDetails.workflowState.description}" />
                
                <label>Permission</label>
                <h:selectOneMenu id="workflowStatePermission" value="#{workflowDefinitionDetails.workflowState.permission}" converter="#{enumTypeConverter}">
                    <f:selectItem itemLabel="Group" itemValue="GROUP" />
                    <f:selectItem itemLabel="User" itemValue="USER" />
                </h:selectOneMenu>
                
                <label>Actor</label>
                <h:selectOneMenu id="workflowStateRole" value="#{workflowDefinitionDetails.workflowState.actorRole}" converter="#{userRoleConverter}">
                    <f:selectItems value="#{common.userRoles}" />
                </h:selectOneMenu>
                
                <label>Default Option</label>
                <h:selectOneMenu id="workflowStateDefaultOption" value="#{workflowDefinitionDetails.workflowState.defaultOption}" converter="#{workflowStateOptionConverter}">
                    <f:selectItems value="#{cof:listToMap(workflowDefinitionDetails.workflowState.options, 'name')}" />
                </h:selectOneMenu>

                <f:facet name="footer">
                    <h:commandLink id="btnAddWorkflowState" class="btn btn-primary" value="#{global.generic_SAVE}" actionListener="#{workflowDefinitionDetails.onSaveWorkflowState()}">
                        <f:param name="includeViewParams" value="true" />
                        <f:param name="id" value="#{workflowDefinitionDetails.id}"/>
                        <f:ajax execute="@form" render=":frmWorkflowDefinitionDetailsEdit:innerTabWorkflowStates" onevent="onSaveWorkflowState" />
                    </h:commandLink>

                    <script>
                        function onSaveWorkflowState(e) {
                            if (e.status == 'success') {
                                $('#frmWorkflowStateDetails\\:mdlWorkflowStateDetails').modal('hide');
                            }
                        }
                    </script>
                </f:facet>
            </bootstrap:modal>
        </h:form>


    </ui:define>
</ui:composition>
